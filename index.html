<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Brauereienlauf - Streckensimulator</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="icon" type="image/svg+xml" href="icons/brauereienlauf_gestaltungselemente_maennchen_beigea_rgb.svg">
<link rel="apple-touch-icon" sizes="180x180" href="icons/brauereienlauf_gestaltungselemente_maennchen_beigea_rgb.svg">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
<style>
/* --- Global --- */
/* Grundlayout und Schriftart der Seite */
body { 
  margin: 0; 
  font-family: 'Inter', sans-serif; 
  display: flex; 
  height: 100vh; 
  overflow: hidden; 
}

/* --- Sidebar --- */
/* Layout, Hintergrund, Scroll und Schatten */
#sidebar { 
  width: 300px; 
  background: #FCF6EE; 
  color: #333; 
  padding: 10px; 
  box-shadow: 2px 0 5px rgba(0,0,0,0.1); 
  display: flex; 
  flex-direction: column; 
  gap: 10px; 
  overflow-y: auto; 
  z-index: 1000; 
}

/* Logo Bereich oben in der Sidebar */
#sidebarLogo { 
  background: #212121; 
  text-align: center; 
  margin-bottom: 10px; 
  padding: 10px; 
}
#sidebarLogo img { 
  max-width: 80%; 
  height: auto; 
  display: block; 
  margin: 0 auto; 
}

/* Farbquadrat und Delete-Button im Track Header */
.colorIndicator,
.track-header .deleteTrackBtn {
  width: 24px;
  height: 24px;
  border-radius: 4px;
  border: 1px solid #999;      
  display: flex;
  align-items: center;
  justify-content: center;
  margin-left: 5px;            
  box-sizing: border-box;
}

/* Delete-Button spezifisches Styling */
.track-header .deleteTrackBtn {
  background: #FF6600;
  color: #fff;
  border: 1px solid #999;
  font-weight: bold;
  font-size: 14px;
  line-height: 1;
  margin: 0;
  padding: 0;
  cursor: pointer;
}
.track-header .deleteTrackBtn:hover {
  background: #cc5200;
}

/* --- Track Header & Name --- */
/* Allgemeines Layout und Styling für Track Header */
.track-header { 
  display: flex; 
  align-items: center; 
  justify-content: center; /* Zentriert horizontal */
  gap: 8px; /* Abstand zwischen Farbe & Button */
  cursor: default; 
  padding: 6px 10px; 
  font-weight: bold; 
  background: #DED0BA; 
  border-bottom: 1px solid #ccc; 
  user-select: none; 
  border-radius: 6px; 
  color: #000; 
}

/* Hover-Effekte für Track Header */
.track-header .toggleSymbol { color: #000; }
.track-header:hover { background: #7664AA; }
.track-header:hover .toggleSymbol { color: #fff; }
.track-header:hover .trackName:not(:focus) { color: #fff; }

/* Track Name Eingabefeld */
.trackName { 
  flex: 1; 
  padding: 2px 4px; 
  border-radius: 4px; 
  background: transparent; 
  color: #000; 
}
.trackName:focus { 
  background: white; 
  color: #000; 
  outline: 2px solid #FF6600; 
}

/* Standard Button Styling */
button { 
  background: #FF6600; 
  color: white; 
  border: none; 
  border-radius: 4px; 
  padding: 6px 10px; 
  cursor: pointer; 
  margin-top: 6px; 
}
button:hover { background: #cc5200; }

/* --- Track Body / Form Labels & Inputs --- */
.track-body { 
  display: none; 
  padding: 8px 10px; 
}
.track-body label { 
  display: block; 
  font-size: 13px; 
  margin-top: 4px; 
}

/* Inputfelder Styling */
input[type="file"],
input[type="time"],
input[type="text"],
input[type="color"] {
  width: 100%;
  font-size: 14px;
  box-sizing: border-box;
}

/* --- Map / Slider --- */
#map { 
  flex: 1; 
  position: relative; 
  z-index: 0; 
}

/* --- Slider Styling --- */
#sliderContainer {
  position: absolute;
  bottom: 0;
  left: 321px;
  right: 0;
  background: #FCF6EE;
  padding: 10px;
  box-shadow: 0 -2px 5px rgba(0,0,0,0.1);
  display: flex;
  align-items: center;
  gap: 10px;
  z-index: 2000;
}

#timeSlider {
  -webkit-appearance: none;
  appearance: none;
  width: 100%;
  height: 6px;
  border-radius: 5px;
  outline: none;
  cursor: pointer;
  --slider-progress: 0%;
}

/* Chrome, Edge, Safari */
#timeSlider::-webkit-slider-runnable-track {
  height: 6px;
  border-radius: 5px;
  background: linear-gradient(to right, #7664AA var(--slider-progress), #DED0BA var(--slider-progress));
}
#timeSlider::-webkit-slider-thumb {
  -webkit-appearance: none;
  appearance: none;
  width: 18px;
  height: 18px;
  border-radius: 50%;
  background: #7664AA;
  border: 2px solid #FCF6EE;
  cursor: pointer;
  margin-top: -6px;
  transition: background 0.2s;
}
#timeSlider::-webkit-slider-thumb:hover { background: #5d4d8a; }

/* Firefox */
#timeSlider::-moz-range-track {
  background: #DED0BA;
  height: 6px;
  border-radius: 5px;
}
#timeSlider::-moz-range-progress {
  background: #7664AA;
  height: 6px;
  border-radius: 5px;
}
#timeSlider::-moz-range-thumb {
  width: 18px;
  height: 18px;
  border-radius: 50%;
  background: #7664AA;
  border: 2px solid #FCF6EE;
  cursor: pointer;
  transition: background 0.2s;
}
#timeSlider::-moz-range-thumb:hover { background: #5d4d8a; }

/* Zeit Label Styling */
#timeLabel { min-width: 80px; font-weight: bold; }

/* --- Leaflet Popups / Tooltips --- */
.leaflet-popup-content, 
.leaflet-tooltip { font-family: 'Inter', sans-serif; }

/* --- Optional: Alle Texte im Akkordeon und Sidebar Input/Labels --- */
.track-body * { font-family: 'Inter', sans-serif; }

/* Monospaced Zahlen in Inputs für bessere Lesbarkeit */
input[type="time"],
input[type="text"] { font-variant-numeric: tabular-nums; }
</style>
</head>
<body>

<div id="sidebar">
  <div id="sidebarLogo"><img src="icons/brauereienlauf-sued-logo.svg" alt="Brauereienlauf Logo"></div>
  <button id="addTrackBtn">Strecke hinzufügen</button>
  <div id="trackList"></div>
</div>

<div id="map"></div>

<div id="sliderContainer" style="display:none;">
  <input type="range" id="timeSlider" step="1" value="0" style="flex:1;">
  <span id="timeLabel">0:00</span>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
/* --- Karte und Basiselemente --- */
const map = L.map('map').setView([49.9, 11.0], 12);
L.tileLayer('https://tile.openstreetmap.de/{z}/{x}/{y}.png', {
  maxZoom: 19,
  attribution: '© OpenStreetMap-Mitwirkende'
}).addTo(map);

/* --- Icons --- */
const poiIcon = L.icon({ iconUrl: "icons/brauereienlauf_gestaltungselemente_maennchen_orange_rgb.svg", iconSize: [32,32], iconAnchor: [16,32] });
const fastRunnerIcon = L.icon({ iconUrl: "icons/brauereienlauf_gestaltungselemente_maennchen_gruen_rgb.svg", iconSize:[24,24], iconAnchor:[12,12] });
const slowRunnerIcon = L.icon({ iconUrl: "icons/brauereienlauf_gestaltungselemente_maennchen_orange_rgb.svg", iconSize:[24,24], iconAnchor:[12,12] });

/* --- Datenstrukturen --- */
let tracks = [];
const predefinedColors = ["#36542C","#FF6600","#7664AA","#212121","#DED0BA"];
const predefinedTracks = [
  { name:"Marathon", gpx:"tracks/M.gpx", startTime:"09:00", endTime:"16:00", fastPace:"03:30", slowPace:"09:00" },
  { name:"Halbmarathon", gpx:"tracks/HM.gpx", startTime:"11:00", endTime:"16:00", fastPace:"03:30", slowPace:"09:00" },
  { name:"10 km", gpx:"tracks/10k.gpx", startTime:"13:00", endTime:"16:00", fastPace:"03:30", slowPace:"09:00" },
  { name:"5 km", gpx:"tracks/5km.gpx", startTime:"13:30", endTime:"16:00", fastPace:"03:30", slowPace:"09:00" }
];

/* --- Hilfsfunktionen --- */
function timeToMinutes(t){ const [h,m]=t.split(":").map(Number); return h*60+m; }
function minutesToTime(m){ const h=Math.floor(m/60); const mm=m%60; return `${h.toString().padStart(2,'0')}:${mm.toString().padStart(2,'0')}`; }
function parsePace(p){ if(!p||p==="--:--") return null; const [min,sec]=p.split(":").map(Number); return min*60+(sec||0); }
function paceToMetersPerMinute(p){ const s=parsePace(p); return s?1000/(s/60):null; }
function totalLength(latlngs){ let d=0; for(let i=1;i<latlngs.length;i++) d+=latlngs[i-1].distanceTo(latlngs[i]); return d; }
function interpolatePoint(latlngs,f){ if(!latlngs.length) return null; if(f<=0)return latlngs[0]; if(f>=1)return latlngs[latlngs.length-1]; const total=totalLength(latlngs); let dist=0; for(let i=1;i<latlngs.length;i++){ const seg=latlngs[i-1].distanceTo(latlngs[i]); if(dist+seg>=total*f){ const r=(total*f-dist)/seg; return L.latLng(latlngs[i-1].lat+(latlngs[i].lat-latlngs[i-1].lat)*r,latlngs[i-1].lng+(latlngs[i].lng-latlngs[i-1].lng)*r); } dist+=seg;} return latlngs[latlngs.length-1]; }

/* --- POIs --- */
const pois = [
  { name:"Start und Ziel", coords:[49.91086414586559,11.008078342287886], description:"Start und Zielbereich Tanzwiesen Litzendorf" },
  { name:"Brauerei Knoblach", coords:[49.92612562825621,11.006192497921718], description:"VP Brauerei Knoblach" },
  { name:"Brauerei Hölzlein", coords:[49.916433164362154,11.044922412182059], description:"VP Brauerei Hölzlein" },
  { name:"Brauerei Hönig", coords:[49.91854570624229,11.074094351945764], description:"VP Brauerei Hönig" }
];
pois.forEach(p=>{
  const m=L.marker(p.coords,{icon:poiIcon}).addTo(map);
  m.bindTooltip(p.name);
  m.on("click",()=>showDistancesToPoi(p,m));
});

/* --- POI-Infos --- */
function showDistancesToPoi(poi, marker){
  let info=`<b>${poi.name}</b><br>${poi.description}<hr>`;
  let hasTrack=false;
  const poiLatLng=L.latLng(poi.coords);
  tracks.forEach(track=>{
    if(!track.trackPoints||!track.fastSpeed||!track.slowSpeed||!track.startTime)return;
    let minDist=Infinity,distAlong=0,distSoFar=0;
    for(let i=1;i<track.trackPoints.length;i++){
      const p1=track.trackPoints[i-1],p2=track.trackPoints[i],seg=p1.distanceTo(p2);
      const d=Math.min(p1.distanceTo(poiLatLng),p2.distanceTo(poiLatLng));
      if(d<minDist){minDist=d;distAlong=distSoFar;}
      distSoFar+=seg;
    }
    if(minDist>40)return;
    hasTrack=true;
    const tStart=timeToMinutes(track.startTime);
    const fastArrival=minutesToTime(Math.floor(tStart+distAlong/track.fastSpeed));
    const slowArrival=minutesToTime(Math.floor(tStart+distAlong/track.slowSpeed));
    info+=`<b>${track.name}</b><br>Erster Läufer: ${fastArrival} Uhr<br>Letzter Läufer: ${slowArrival} Uhr<br><br>`;
  });
  if(!hasTrack) info+="Keine Strecke führt hier vorbei.";
  marker.bindPopup(info).openPopup();
}

/* --- Slider --- */
const slider=document.getElementById("timeSlider");
const timeLabel=document.getElementById("timeLabel");

function updateMarkers(){
  const now=Number(slider.value);
  timeLabel.innerText=minutesToTime(now);
  tracks.forEach(track=>{
    if(!track.trackPoints||!track.fastSpeed)return;
    const minsSinceStart=now-timeToMinutes(track.startTime);
    const fastDist=Math.max(Math.min(track.fastSpeed*minsSinceStart,track.totalDist),0);
    const slowDist=Math.max(Math.min(track.slowSpeed*minsSinceStart,track.totalDist),0);
    const fastFrac=track.totalDist?fastDist/track.totalDist:0;
    const slowFrac=track.totalDist?slowDist/track.totalDist:0;
    const fastPos=interpolatePoint(track.trackPoints,fastFrac);
    const slowPos=interpolatePoint(track.trackPoints,slowFrac);
    if(track.fastMarker) track.fastMarker.setLatLng(fastPos);
    if(track.slowMarker) track.slowMarker.setLatLng(slowPos);
  });
}

function updateSliderRange(){
  if(!tracks.length){document.getElementById("sliderContainer").style.display="none";return;}
  const start=tracks.map(t=>timeToMinutes(t.startTime));
  const end=tracks.map(t=>timeToMinutes(t.endTime));
  slider.min=Math.min(...start);
  slider.max=Math.max(...end);
  slider.value=slider.min;
  document.getElementById("sliderContainer").style.display="flex";
  updateMarkers();
}
slider.addEventListener("input",()=>requestAnimationFrame(updateMarkers));

/* --- GPX laden (allgemein) --- */
function loadGpx(gpxPath,trackDiv){
  fetch(gpxPath).then(r=>r.text()).then(txt=>{
    const xml=new DOMParser().parseFromString(txt,"text/xml");
    let pts=xml.getElementsByTagName("trkpt");
    if(!pts.length) pts=xml.getElementsByTagName("rtept");
    const latlngs=Array.from(pts).map(p=>L.latLng(p.getAttribute("lat"),p.getAttribute("lon")));
    const color=trackDiv.querySelector(".trackColor").value;
    const fast=paceToMetersPerMinute(trackDiv.querySelector(".fastPace").value);
    const slow=paceToMetersPerMinute(trackDiv.querySelector(".slowPace").value);
    const obj={
      id:Date.now()+Math.random(),
      name:trackDiv.querySelector(".trackName").innerText.trim(),
      trackPoints:latlngs,
      totalDist:totalLength(latlngs),
      color,
      startTime:trackDiv.querySelector(".startTime").value,
      endTime:trackDiv.querySelector(".endTime").value,
      fastSpeed:fast,
      slowSpeed:slow
    };
    obj.fullTrackLayer=L.polyline(latlngs,{color,weight:4}).addTo(map);
    obj.fastMarker=L.marker(latlngs[0],{icon:fastRunnerIcon}).addTo(map);
    obj.slowMarker=L.marker(latlngs[0],{icon:slowRunnerIcon}).addTo(map);
    tracks.push(obj);
    trackDiv.trackObj=obj;
    map.fitBounds(obj.fullTrackLayer.getBounds());
    updateSliderRange();
  }).catch(e=>console.error("Fehler beim GPX-Laden:",e));
}

/* --- Reset-Funktion --- */
function resetTrackSettings(trackDiv){
  ["startTime","endTime","fastPace","slowPace"].forEach(cls=>{
    const el=trackDiv.querySelector(`.${cls}`);
    if(el) el.value="";
  });
  if(trackDiv.trackObj){
    const {fastMarker,slowMarker,trackPoints}=trackDiv.trackObj;
    if(trackPoints?.length){
      fastMarker.setLatLng(trackPoints[0]);
      slowMarker.setLatLng(trackPoints[0]);
    }
  }
}

/* --- Track hinzufügen (manuell) --- */
function addTrackForm(predef){
  const trackList=document.getElementById("trackList");
  const trackDiv=document.createElement("div");
  trackDiv.className="track";
  const color=predefinedColors[trackList.querySelectorAll(".track").length % predefinedColors.length];
  trackDiv.innerHTML=`
    <div class="track-header">
      <span class="toggleSymbol">&#9660;</span>
      <span class="trackName" contenteditable="true">${predef?.name||"Neue Strecke"}</span>
      <div class="colorIndicator" style="background:${color}"></div>
      <button class="deleteTrackBtn">X</button>
    </div>
    <div class="track-body">
      <label>Trackfarbe: <input type="color" class="trackColor" value="${color}"></label>
      <label>Startzeit: <input type="time" class="startTime" value="${predef?.startTime||''}"></label>
      <label>Zielzeit: <input type="time" class="endTime" value="${predef?.endTime||''}"></label>
      <label>Schnellste Pace (min/km): <input type="text" class="fastPace" value="${predef?.fastPace||'--:--'}"></label>
      <label>Langsamste Pace (min/km): <input type="text" class="slowPace" value="${predef?.slowPace||'--:--'}"></label>
      <label>GPX-Datei: <input type="file" class="gpxFile" accept=".gpx"></label>
      <button class="loadTrackBtn" style="background:#FF6600;color:white;border:none;border-radius:4px;margin-top:6px;">Track laden</button>
      <button class="resetBtn" style="background:#eee;color:#000;border:1px solid #ccc;border-radius:4px;margin-top:4px;">Zurücksetzen</button>
    </div>
  `;
  trackList.appendChild(trackDiv);

  const header=trackDiv.querySelector(".track-header");
  const body=trackDiv.querySelector(".track-body");
  const toggle=header.querySelector(".toggleSymbol");
  const del=header.querySelector(".deleteTrackBtn");
  const colorPicker=trackDiv.querySelector(".trackColor");
  const colorIndicator=trackDiv.querySelector(".colorIndicator");
  const loadBtn=trackDiv.querySelector(".loadTrackBtn");
  const resetBtn=trackDiv.querySelector(".resetBtn");

  toggle.addEventListener("click",()=>{const open=trackDiv.classList.toggle("open");body.style.display=open?"block":"none";toggle.innerHTML=open?"&#9660;":"&#9654;";});
  trackDiv.classList.add("open");body.style.display="block";

  del.addEventListener("click",()=>{ if(trackDiv.trackObj){["fullTrackLayer","fastMarker","slowMarker"].forEach(k=>trackDiv.trackObj[k]?.remove()); tracks=tracks.filter(t=>t.id!==trackDiv.trackObj.id);} trackDiv.remove(); updateSliderRange(); });
  colorPicker.addEventListener("input",()=>{colorIndicator.style.background=colorPicker.value; if(trackDiv.trackObj?.fullTrackLayer) trackDiv.trackObj.fullTrackLayer.setStyle({color:colorPicker.value});});
  resetBtn.addEventListener("click",()=>resetTrackSettings(trackDiv));

  // Manuell geladen
  loadBtn.addEventListener("click",()=>{
    const fileInput=trackDiv.querySelector(".gpxFile");
    if(fileInput.files.length===0) return alert("Bitte GPX-Datei auswählen!");
    const file=fileInput.files[0];
    const reader=new FileReader();
    reader.onload=e=>{
      const xml=new DOMParser().parseFromString(e.target.result,"text/xml");
      const pts=xml.getElementsByTagName("trkpt");
      if(!pts.length) return alert("Keine gültigen GPX-Punkte gefunden!");
      const latlngs=Array.from(pts).map(p=>L.latLng(p.getAttribute("lat"),p.getAttribute("lon")));
      const color=colorPicker.value;
      const fast=paceToMetersPerMinute(trackDiv.querySelector(".fastPace").value);
      const slow=paceToMetersPerMinute(trackDiv.querySelector(".slowPace").value);
      const obj={
        id:Date.now()+Math.random(),
        name:trackDiv.querySelector(".trackName").innerText.trim(),
        trackPoints:latlngs,
        totalDist:totalLength(latlngs),
        color,
        startTime:trackDiv.querySelector(".startTime").value,
        endTime:trackDiv.querySelector(".endTime").value,
        fastSpeed:fast,
        slowSpeed:slow
      };
      obj.fullTrackLayer=L.polyline(latlngs,{color,weight:4}).addTo(map);
      obj.fastMarker=L.marker(latlngs[0],{icon:fastRunnerIcon}).addTo(map);
      obj.slowMarker=L.marker(latlngs[0],{icon:slowRunnerIcon}).addTo(map);
      trackDiv.trackObj=obj;
      tracks.push(obj);
      map.fitBounds(obj.fullTrackLayer.getBounds());
      updateSliderRange();
    };
    reader.readAsText(file);
  });

  return trackDiv;
}

/* --- Initialisierung --- */
window.addEventListener("DOMContentLoaded",()=>{
  // Predefined hinzufügen
  predefinedTracks.forEach(pt=>{
    const trackDiv=addTrackForm(pt);
    if(pt.gpx) loadGpx(pt.gpx, trackDiv);
  });
  // Manuell hinzufügen-Button
  document.getElementById("addTrackBtn").addEventListener("click",()=>addTrackForm());
});
</script>

</body>
</html>
