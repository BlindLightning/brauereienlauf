<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Brauereienlauf - Streckensimulator</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="icon" type="image/svg+xml" href="icons/brauereienlauf_gestaltungselemente_maennchen_beigea_rgb.svg">
<link rel="apple-touch-icon" sizes="180x180" href="icons/brauereienlauf_gestaltungselemente_maennchen_beigea_rgb.svg">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
body { margin:0; font-family:sans-serif; display:flex; height:100vh; overflow:hidden; }
#sidebar { width:300px; background:#FCF6EE; color:#333; padding:10px; box-shadow:2px 0 5px rgba(0,0,0,0.1); display:flex; flex-direction:column; gap:10px; overflow-y:auto; z-index:1000; }
#sidebarLogo { background:#212121; text-align:center; margin-bottom:10px; padding:10px; }
#sidebarLogo img { max-width:80%; height:auto; display:block; margin:0 auto; }
.track-header { display:flex; align-items:center; cursor:default; padding:6px 10px; font-weight:bold; background:#DED0BA; border-bottom:1px solid #ccc; user-select:none; gap:5px; border-radius:6px; color:#000; }
.track-header .toggleSymbol { color:#000; }
.track-header:hover { background:#7664AA; }
.track-header:hover .toggleSymbol { color:#fff; }
.track-header:hover .trackName:not(:focus) { color:#fff; }
.trackName { flex:1; padding:2px 4px; border-radius:4px; background:transparent; color:#000; }
.trackName:focus { background:white; color:#000; outline:2px solid #FF6600; }
.colorIndicator { width:20px; height:20px; border-radius:4px; border:1px solid #999; margin-left:5px; }
button { background:#FF6600; color:white; border:none; border-radius:4px; padding:6px 10px; cursor:pointer; margin-top:6px; }
button:hover { background:#cc5200; }
.track-body { display:none; padding:8px 10px; }
.track-body label { display:block; font-size:13px; margin-top:4px; }
input[type="file"], input[type="time"], input[type="text"], input[type="color"] { width:100%; }
#map { flex:1; position:relative; z-index:0; }
#sliderContainer { position:absolute; bottom:0; left:321px; right:0; background:#fff; padding:10px; box-shadow:0 -2px 5px rgba(0,0,0,0.1); display:flex; align-items:center; gap:10px; z-index:2000; }
#timeLabel { min-width:80px; font-weight:bold; }

/* Mobile */
@media(max-width:768px){
  #sidebar { position:absolute; left:0; top:0; height:100%; transform:translateX(-100%); transition:transform 0.3s ease; z-index:2001; }
  #sidebar.open { transform:translateX(0); }
  #menuButton { display:block; position:absolute; top:10px; left:10px; background:#FF6600; color:white; border:none; border-radius:6px; padding:8px 12px; font-size:18px; cursor:pointer; z-index:2002; }
}
#menuButton { display:none; }
</style>
</head>
<body>

<!-- Mobile Menübutton -->
<button id="menuButton">☰ Menü</button>

<div id="sidebar">
  <div id="sidebarLogo"><img src="icons/brauereienlauf-sued-logo.svg" alt="Brauereienlauf Logo"></div>
  <button id="addTrackBtn">Weitere Strecke hinzufügen</button>
  <div id="trackList"></div>
</div>

<div id="map"></div>

<div id="sliderContainer" style="display:none;">
  <input type="range" id="timeSlider" step="1" value="0" style="flex:1;">
  <span id="timeLabel">0:00</span>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
// --- Karte ---
const map = L.map('map').setView([49.9,11.0],12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19, attribution:'© OpenStreetMap-Mitwirkende'}).addTo(map);

// --- POIs ---
const pois = [
  { name:"Start und Ziel", coords:[49.910864,11.008078], description:"Start und Zielbereich Tanzwiesen Litzendorf" },
  { name:"Brauerei Knoblach", coords:[49.926125,11.006192], description:"VP Brauerei Knoblach" },
  { name:"Brauerei Hölzlein", coords:[49.916433,11.044922], description:"VP Brauerei Hölzlein" },
  { name:"Brauerei Hönig", coords:[49.918545,11.074094], description:"VP Brauerei Hönig" },
  { name:"Brauerei Reh", coords:[49.916192,11.050437], description:"VP Brauerei Reh" },
  { name:"Brauerei Brandholz", coords:[49.899626,11.031593], description:"VP Brauerei Brandholz" },
  { name:"Landgasthof Büttel", coords:[49.881684,11.012945], description:"VP Landgasthof Büttel" },
  { name:"Gasthof Schiller", coords:[49.857716,11.005281], description:"VP Gasthof Schiller" },
  { name:"Schwanenkeller", coords:[49.851879,10.97576], description:"VP Schwanenkeller" },
  { name:"Brauerei Sauer", coords:[49.867831,10.996951], description:"VP Brauerei Sauer" },
  { name:"Regnitztaler Alm", coords:[49.887659,10.981377], description:"VP Regnitztaler Alm" },
  { name:"Kunigundenruh", coords:[49.903828,10.960579], description:"VP Kunigundenruh" }
];
const poiIcon = L.icon({iconUrl:"icons/brauereienlauf_gestaltungselemente_maennchen_orange_rgb.svg", iconSize:[32,32], iconAnchor:[16,32], popupAnchor:[0,-32]});
pois.forEach(poi=>{
  const marker=L.marker(poi.coords,{icon:poiIcon}).addTo(map);
  marker.bindTooltip(poi.name);
});

// --- Tracks ---
let tracks=[];
const predefinedColors=["#36542C","#FF6600","#7664AA","#212121","#DED0BA"];

// --- Slider ---
const slider=document.getElementById("timeSlider");
const timeLabel=document.getElementById("timeLabel");

// --- Helperfunktionen ---
function parsePace(p){ if(!p||p==="--:--") return null; const parts=p.split(":").map(Number); return parts.length===1?parts[0]*60:parts[0]*60+parts[1]; }
function paceToMetersPerMinute(p){ const sec=parsePace(p); return sec?1000/(sec/60):null; }
function totalLength(latlngs){ let d=0; for(let i=1;i<latlngs.length;i++) d+=latlngs[i-1].distanceTo(latlngs[i]); return d; }
function interpolatePoint(latlngs,f){ if(!latlngs||!latlngs.length) return null; if(f<=0)return latlngs[0]; if(f>=1)return latlngs[latlngs.length-1]; const total=totalLength(latlngs); let dist=0; for(let i=1;i<latlngs.length;i++){ const seg=latlngs[i-1].distanceTo(latlngs[i]); if(dist+seg>=total*f){ const r=(total*f-dist)/seg; return L.latLng(latlngs[i-1].lat+(latlngs[i].lat-latlngs[i-1].lat)*r, latlngs[i-1].lng+(latlngs[i].lng-latlngs[i-1].lng)*r); } dist+=seg; } return latlngs[latlngs.length-1]; }
function timeToMinutes(t){ if(!t) return null; const [h,m]=t.split(":").map(Number); return h*60+m; }
function minutesToTime(m){ const h=Math.floor(m/60); const mm=m%60; return `${h.toString().padStart(2,'0')}:${mm.toString().padStart(2,'0')}`; }

// --- Pace Mask ---
function initPaceField(input){
  input.value="--:--";
  input.addEventListener("focus",()=>{ if(input.value==="--:--") input.value=""; });
  input.addEventListener("blur",()=>{ if(input.value==="") input.value="--:--"; });
  input.addEventListener("input",()=>{ let val=input.value.replace(/\D/g,'').slice(0,4); if(val.length>2) val=val.slice(0,2)+":"+val.slice(2); input.value=val; });
}

// --- Trackname Placeholder ---
function initTrackName(trackNameEl){
  const DEFAULT_TRACK_NAME="Neue Strecke";
  if(!trackNameEl.innerText.trim()) trackNameEl.innerText=DEFAULT_TRACK_NAME;
  trackNameEl.addEventListener("focus",()=>{
    if(trackNameEl.innerText===DEFAULT_TRACK_NAME){ trackNameEl.innerText=""; const range=document.createRange(); const sel=window.getSelection(); range.setStart(trackNameEl,0); range.collapse(true); sel.removeAllRanges(); sel.addRange(range); }
  });
  trackNameEl.addEventListener("blur",()=>{ if(trackNameEl.innerText.trim()==="") trackNameEl.innerText=DEFAULT_TRACK_NAME; });
}

// --- Track hinzufügen ---
function addTrackForm(){
  const trackList=document.getElementById("trackList");
  const trackDiv=document.createElement("div");
  trackDiv.className="track";
  const color=predefinedColors[trackList.querySelectorAll(".track").length%predefinedColors.length];
  trackDiv.innerHTML=`
    <div class="track-header">
      <span class="toggleSymbol">&#9654;</span>
      <span class="trackName" contenteditable="true">Neue Strecke</span>
      <div class="colorIndicator" style="background:${color}"></div>
      <button class="deleteTrackBtn">X</button>
    </div>
    <div class="track-body">
      <label>Trackfarbe: <input type="color" class="trackColor" value="${color}"></label>
      <label>GPX-Datei: <input type="file" class="fileInput" accept=".gpx"></label>
      <label>Startzeit: <input type="time" class="startTime"></label>
      <label>Zielzeit: <input type="time" class="endTime"></label>
      <label>Schnellste Pace (min/km): <input type="text" class="fastPace" maxlength="5"></label>
      <label>Langsamste Pace (min/km): <input type="text" class="slowPace" maxlength="5"></label>
      <button class="loadBtn">Track laden</button>
      <button class="resetBtn">Reset</button>
    </div>
  `;
  trackList.appendChild(trackDiv);
  const header=trackDiv.querySelector(".track-header");
  const body=trackDiv.querySelector(".track-body");
  const toggle=header.querySelector(".toggleSymbol");
  const deleteBtn=header.querySelector(".deleteTrackBtn");
  const colorPicker=trackDiv.querySelector(".trackColor");
  const colorIndicator=trackDiv.querySelector(".colorIndicator");
  const trackNameEl=trackDiv.querySelector(".trackName");

  initTrackName(trackNameEl);
  initPaceField(trackDiv.querySelector(".fastPace"));
  initPaceField(trackDiv.querySelector(".slowPace"));

  header.addEventListener("click",()=>{ const open=body.style.display==="block"; body.style.display=open?"none":"block"; toggle.innerHTML=open?"&#9654;":"&#9660;"; });
  deleteBtn.addEventListener("click",e=>{ e.stopPropagation(); if(trackDiv.trackObj){ ["fullTrackLayer","redSegment","fastMarker","slowMarker"].forEach(k=>{ if(trackDiv.trackObj[k]) map.removeLayer(trackDiv.trackObj[k]); }); tracks=tracks.filter(t=>t.id!==trackDiv.trackObj.id); } trackDiv.remove(); });
  colorPicker.addEventListener("input",()=>{ colorIndicator.style.background=colorPicker.value; if(trackDiv.trackObj?.fullTrackLayer) trackDiv.trackObj.fullTrackLayer.setStyle({color:colorPicker.value}); });
  trackDiv.querySelector(".loadBtn").addEventListener("click",()=>loadTrack(trackDiv));
  trackDiv.querySelector(".resetBtn").addEventListener("click",()=>{
    trackDiv.querySelector(".startTime").value="";
    trackDiv.querySelector(".endTime").value="";
    trackDiv.querySelector(".fastPace").value="--:--";
    trackDiv.querySelector(".slowPace").value="--:--";
    if(trackDiv.trackObj){ ["fullTrackLayer","redSegment","fastMarker","slowMarker"].forEach(k=>{ if(trackDiv.trackObj[k]){ map.removeLayer(trackDiv.trackObj[k]); trackDiv.trackObj[k]=null; } }); trackDiv.trackObj.startTime=null; trackDiv.trackObj.endTime=null; trackDiv.trackObj.fastSpeed=null; trackDiv.trackObj.slowSpeed=null; }
  });
}

// --- Track laden ---
function loadTrack(trackDiv){
  const file=trackDiv.querySelector(".fileInput").files[0];
  if(!file) return alert("Bitte GPX-Datei auswählen.");
  if(file.size>2*1024*1024) return alert("Datei zu groß (>2MB)");
  const reader=new FileReader();
  reader.onload=e=>{
    const xmlDoc=new DOMParser().parseFromString(e.target.result,"text/xml");
    let nodes=xmlDoc.getElementsByTagName("trkpt"); if(!nodes.length) nodes=xmlDoc.getElementsByTagName("rtept"); if(!nodes.length) return alert("Keine Trackpunkte gefunden");
    const latlngs=Array.from(nodes).map(n=>L.latLng(parseFloat(n.getAttribute("lat")),parseFloat(n.getAttribute("lon"))));
    if(!latlngs.length) return alert("Keine gültigen Koordinaten");
    const color=trackDiv.querySelector(".trackColor").value;
    const trackObj={ id:Date.now()+Math.random(), trackPoints:latlngs, totalDist:totalLength(latlngs), color:color };
    trackObj.fullTrackLayer=L.polyline(latlngs,{color,weight:4}).addTo(map);
    trackDiv.trackObj=trackObj; tracks.push(trackObj); map.fitBounds(trackObj.fullTrackLayer.getBounds());
  };
  reader.readAsText(file);
}

document.getElementById("addTrackBtn").addEventListener("click",addTrackForm);

// --- Mobile Menu Toggle ---
const menuButton=document.getElementById("menuButton");
menuButton.addEventListener("click",()=>document.getElementById("sidebar").classList.toggle("open"));
</script>

</body>
</html>

