<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Brauereienlauf - Streckensimulator</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="icon" type="image/svg+xml" href="icons/brauereienlauf_gestaltungselemente_maennchen_beigea_rgb.svg">
<link rel="apple-touch-icon" sizes="180x180" href="icons/brauereienlauf_gestaltungselemente_maennchen_beigea_rgb.svg">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
<style>
<style>
/* ============================
   GLOBAL STYLING
   ============================ */

/* Grundlayout des gesamten Dokuments */
body { 
  margin: 0;                        /* Kein Standard-Abstand */
  font-family: 'Inter', sans-serif; /* Einheitliche Schrift */
  display: flex;                     /* Sidebar + Map nebeneinander */
  height: 100vh;                     /* Volle Höhe des Viewports */
  overflow: hidden;                  /* Keine Scrollbars auf Body */
}

/* ============================
   SIDEBAR
   ============================ */

/* Hauptcontainer Sidebar */
#sidebar { 
  width: 300px; 
  background: #FCF6EE; 
  color: #333; 
  padding: 10px; 
  box-shadow: 2px 0 5px rgba(0,0,0,0.1); /* leichter Schatten rechts */
  display: flex; 
  flex-direction: column; 
  gap: 10px; 
  overflow-y: auto;                  /* Scrollbar wenn Inhalt zu groß */
  z-index: 1000; 
}

/* Logo-Bereich der Sidebar */
#sidebarLogo { 
  background: #212121; 
  text-align: center; 
  margin-bottom: 10px; 
  padding: 10px; 
}

#sidebarLogo img { 
  max-width: 80%; 
  height: auto; 
  display: block; 
  margin: 0 auto; 
}

/* ============================
   TRACK HEADER & ELEMENTS
   ============================ */

/* Farbquadrat & Delete-Button: gleiche Größe, Rand & zentriert */
.colorIndicator,
.track-header .deleteTrackBtn {
  width: 20px;
  height: 20px;
  border-radius: 4px;
  border: 1px solid #999;           /* sichtbarer Rand */
  display: flex;
  align-items: center;
  justify-content: center;
  box-sizing: border-box;           /* Padding & Border in Größe enthalten */
  margin-left: 5px;                  /* Abstand zum vorherigen Element */
}

/* Spezielles Styling für den Delete-Button */
.track-header .deleteTrackBtn {
  background: #FF6600;
  color: #fff;
  font-weight: bold;
  font-size: 14px;
  line-height: 1;
  padding: 0;                        /* Kein zusätzliches Innenpadding */
  margin: 0;
  cursor: pointer;
}

.track-header .deleteTrackBtn:hover {
  background: #cc5200;               /* dunkler bei Hover */
}

/* Track-Header selbst */
.track-header { 
  display: flex; 
  align-items: center; 
  justify-content: flex-start;       /* Elemente links ausrichten */
  gap: 8px;                          /* Abstand zwischen Icon, Name & Button */
  cursor: default; 
  padding: 6px 10px; 
  font-weight: bold; 
  background: #DED0BA; 
  border-bottom: 1px solid #ccc; 
  border-radius: 6px; 
  color: #000; 
  user-select: none;                 /* Verhindert Textauswahl beim Klicken */
}

.track-header:hover { 
  background: #7664AA;               /* Hover-Hintergrund */
}

.track-header .toggleSymbol { 
  color: #000; 
}
.track-header:hover .toggleSymbol { 
  color: #fff; 
}

/* Trackname im Header */
.trackName { 
  flex: 1;                            /* nimmt restlichen Platz ein */
  padding: 2px 4px; 
  border-radius: 4px; 
  background: transparent; 
  color: #000; 
}

.trackName:focus { 
  background: white; 
  color: #000; 
  outline: 2px solid #FF6600;        /* sichtbarer Fokus-Rahmen */
}

/* ============================
   GENERELLE BUTTONS
   ============================ */
button { 
  background: #FF6600; 
  color: white; 
  border: none; 
  border-radius: 4px; 
  padding: 6px 10px; 
  cursor: pointer; 
  margin-top: 6px; 
}

button:hover { 
  background: #cc5200; 
}

/* ============================
   TRACK BODY / FORM ELEMENTS
   ============================ */

/* Container für Track-Details (eingeklappt) */
.track-body { 
  display: none; 
  padding: 8px 10px; 
}

/* Labels in Track-Formular */
.track-body label { 
  display: block; 
  font-size: 13px; 
  margin-top: 4px; 
}

/* Inputs: Datei, Zeit, Text, Farbe */
input[type="file"],
input[type="time"],
input[type="text"],
input[type="color"] {
  width: 100%; 
  font-size: 14px;
  box-sizing: border-box;           /* Padding & Border in Größe enthalten */
}

/* ============================
   MAP / SLIDER
   ============================ */

/* Leaflet Map Container */
#map { 
  flex: 1; 
  position: relative; 
  z-index: 0; 
}

/* Slider Container unten */
#sliderContainer {
  position: absolute;
  bottom: 0;
  left: 321px;                      /* rechts neben Sidebar */
  right: 0;
  background: #FCF6EE;
  padding: 10px;
  box-shadow: 0 -2px 5px rgba(0,0,0,0.1); /* leichter Schatten nach oben */
  display: flex;
  align-items: center;
  gap: 10px;
  z-index: 2000;
}

/* Slider selbst */
#timeSlider {
  -webkit-appearance: none;
  appearance: none;
  width: 100%;
  height: 6px;
  border-radius: 5px;
  outline: none;
  cursor: pointer;
  --slider-progress: 0%;
}

/* Chrome / Safari */
#timeSlider::-webkit-slider-runnable-track {
  height: 6px;
  border-radius: 5px;
  background: linear-gradient(to right, #7664AA var(--slider-progress), #DED0BA var(--slider-progress));
}
#timeSlider::-webkit-slider-thumb {
  -webkit-appearance: none;
  appearance: none;
  width: 18px;
  height: 18px;
  border-radius: 50%;
  background: #7664AA;
  border: 2px solid #FCF6EE;
  cursor: pointer;
  margin-top: -6px;                 /* zentriert über Track */
  transition: background 0.2s;
}
#timeSlider::-webkit-slider-thumb:hover { 
  background: #5d4d8a; 
}

/* Firefox */
#timeSlider::-moz-range-track {
  background: #DED0BA;
  height: 6px;
  border-radius: 5px;
}
#timeSlider::-moz-range-progress {
  background: #7664AA;
  height: 6px;
  border-radius: 5px;
}
#timeSlider::-moz-range-thumb {
  width: 18px;
  height: 18px;
  border-radius: 50%;
  background: #7664AA;
  border: 2px solid #FCF6EE;
  cursor: pointer;
  transition: background 0.2s;
}
#timeSlider::-moz-range-thumb:hover { 
  background: #5d4d8a; 
}

/* Slider Label (Zeit) */
#timeLabel { 
  min-width: 80px; 
  font-weight: bold; 
}

/* ============================
   LEAFLET POPUPS / TOOLTIP
   ============================ */
.leaflet-popup-content,
.leaflet-tooltip { 
  font-family: 'Inter', sans-serif; 
}

/* ============================
   OPTIONAL: SIDEBAR INPUTS & TEXT
   ============================ */
.track-body * { 
  font-family: 'Inter', sans-serif; 
}

/* Monospaced Zahlen in Inputs für bessere Ausrichtung */
input[type="time"],
input[type="text"] { 
  font-variant-numeric: tabular-nums; 
}
</style>
</head>
<body>

<div id="sidebar">
  <div id="sidebarLogo"><img src="icons/brauereienlauf-sued-logo.svg" alt="Brauereienlauf Logo"></div>
  <button id="addTrackBtn">Strecke hinzufügen</button>
  <div id="trackList"></div>
</div>

<div id="map"></div>

<div id="sliderContainer" style="display:none;">
  <input type="range" id="timeSlider" step="1" value="0" style="flex:1;">
  <span id="timeLabel">0:00</span>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
// --- Karte ---
const map = L.map('map').setView([49.9, 11.0],12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ maxZoom:19, attribution:'© OpenStreetMap-Mitwirkende' }).addTo(map);

// --- Slider Farbupdate (Chrome/Edge/Safari) ---
const timeSlider = document.getElementById('timeSlider');
if(timeSlider){
  const updateSliderColor = () => {
    const value = (timeSlider.value - timeSlider.min) / (timeSlider.max - timeSlider.min) * 100;
    timeSlider.style.setProperty('--slider-progress', `${value}%`);
  };
  timeSlider.addEventListener('input', updateSliderColor);
  updateSliderColor();
}

// --- POIs ---
const pois = [
  { name:"Start und Ziel", coords:[49.91086414586559,11.008078342287886], description:"Start und Zielbereich Tanzwiesen Litzendorf" },
  { name:"Brauerei Knoblach", coords:[49.92612562825621,11.006192497921718], description:"VP Brauerei Knoblach" },
  { name:"Brauerei Hölzlein", coords:[49.916433164362154,11.044922412182059], description:"VP Brauerei Hölzlein" },
  { name:"Brauerei Hönig", coords:[49.91854570624229,11.074094351945764], description:"VP Brauerei Hönig" },
  { name:"Brauerei Reh", coords:[49.9161925538902,11.050437379307478], description:"VP Brauerei Reh" },
  { name:"Brauerei Brandholz", coords:[49.89962613596553,11.031593469565935], description:"VP Brauerei Brandholz" },
  { name:"Landgasthof Büttel", coords:[49.88168405246902,11.01294568627889], description:"VP Landgasthof Büttel" },
  { name:"Gasthof Schiller", coords:[49.85771626727418,11.005281650520448], description:"VP Gasthof Schiller" },
  { name:"Schwanenkeller", coords:[49.851879458949746,10.97576017952508], description:"VP Schwanenkeller" },
  { name:"Brauerei Sauer", coords:[49.867831104839176,10.996951685705579], description:"VP Brauerei Sauer" },
  { name:"Regnitztaler Alm", coords:[49.88765943343463, 10.981377141550507], description:"VP Regnitztaler Alm" },
  { name:"Kunigundenruh", coords:[49.903828616877256,10.960579372597097], description:"VP Kunigundenruh" }
];

const poiIcon = L.icon({
  iconUrl: "icons/brauereienlauf_gestaltungselemente_maennchen_orange_rgb.svg",
  iconSize: [32,32],
  iconAnchor: [16,32],
  popupAnchor: [0,-32]
});

// --- Neue Icons für Läufer ---
const fastRunnerIcon = L.icon({
  iconUrl: 'icons/brauereienlauf_gestaltungselemente_maennchen_gruen_rgb.svg',
  iconSize: [24, 24],
  iconAnchor: [12, 12],
  popupAnchor: [0, -12]
});

const slowRunnerIcon = L.icon({
  iconUrl: 'icons/brauereienlauf_gestaltungselemente_maennchen_orange_rgb.svg',
  iconSize: [24, 24],
  iconAnchor: [12, 12],
  popupAnchor: [0, -12]
});

// --- Tracks ---
let tracks=[];
const predefinedColors=["#36542C","#FF6600","#7664AA","#212121","#DED0BA"];
let colorIndex=0;

// --- Slider ---
const slider=document.getElementById("timeSlider");
const timeLabel=document.getElementById("timeLabel");

// --- Helperfunktionen ---
function parsePace(p){ if(!p || p==="--:--") return null; const parts=p.split(":").map(Number); if(parts.length===1) return parts[0]*60; return parts[0]*60+parts[1]; }
function paceToMetersPerMinute(p){ const sec=parsePace(p); if(sec===null||sec===0) return null; return 1000/(sec/60); }
function totalLength(latlngs){ let d=0; for(let i=1;i<latlngs.length;i++) d+=latlngs[i-1].distanceTo(latlngs[i]); return d; }
function interpolatePoint(latlngs,f){ if(!latlngs||latlngs.length===0) return null; if(f<=0) return latlngs[0]; if(f>=1) return latlngs[latlngs.length-1]; const total=totalLength(latlngs); let dist=0; for(let i=1;i<latlngs.length;i++){ const seg=latlngs[i-1].distanceTo(latlngs[i]); if(dist+seg>=total*f){ const r=(total*f-dist)/seg; return L.latLng(latlngs[i-1].lat+(latlngs[i].lat-latlngs[i-1].lat)*r, latlngs[i-1].lng+(latlngs[i].lng-latlngs[i-1].lng)*r); } dist+=seg; } return latlngs[latlngs.length-1]; }
function getSubsegment(latlngs,startFrac,endFrac){ if(!latlngs||latlngs.length===0) return []; const total=totalLength(latlngs); let dist=0; const pts=[]; let startAdded=false; for(let i=1;i<latlngs.length;i++){ const seg=latlngs[i-1].distanceTo(latlngs[i]); const segStart=dist; const segEnd=dist+seg; if(!startAdded && segEnd>=total*startFrac){ const r=(total*startFrac-segStart)/seg; pts.push(L.latLng(latlngs[i-1].lat+(latlngs[i].lat-latlngs[i-1].lat)*r, latlngs[i-1].lng+(latlngs[i].lng-latlngs[i-1].lng)*r)); startAdded=true; } if(segEnd>total*startFrac && segStart<total*endFrac) pts.push(latlngs[i]); if(segEnd>=total*endFrac){ const r=(total*endFrac-segStart)/seg; pts.push(L.latLng(latlngs[i-1].lat+(latlngs[i].lat-latlngs[i-1].lat)*r, latlngs[i-1].lng+(latlngs[i].lng-latlngs[i-1].lng)*r)); break; } dist+=seg; } return pts; }
function timeToMinutes(t){ if(!t) return null; const [h,m]=t.split(":").map(Number); return h*60+m; }
function minutesToTime(m){ const h=Math.floor(m/60); const mm=m%60; return `${h.toString().padStart(2,'0')}:${mm.toString().padStart(2,'0')}`; }

// --- POI Marker ---
function showDistancesToPoi(poi, marker){
  const poiLatLng=L.latLng(poi.coords);
  let info=`<b>${poi.name}</b><br>${poi.description}<hr>`;
  let hasRunner=false;

  tracks.forEach(track=>{
    if(!track.trackPoints||!track.startTime||!track.endTime||!track.fastSpeed||!track.slowSpeed) return;
    let closestDist=Infinity; let distAlongTrack=0; let distSoFar=0;
    for(let i=1;i<track.trackPoints.length;i++){
      const p1=track.trackPoints[i-1], p2=track.trackPoints[i], segDist=p1.distanceTo(p2);
      const minDist=Math.min(p1.distanceTo(poiLatLng), p2.distanceTo(poiLatLng));
      if(minDist<closestDist){ closestDist=minDist; distAlongTrack=distSoFar+(minDist===p1.distanceTo(poiLatLng)?0:segDist); }
      distSoFar+=segDist;
    }
    if(closestDist>30) return;
    hasRunner=true;
    const tStart=timeToMinutes(track.startTime);
    const fastArrival=minutesToTime(Math.floor(tStart+distAlongTrack/track.fastSpeed));
    const slowArrival=minutesToTime(Math.floor(tStart+distAlongTrack/track.slowSpeed));
    info+=`<b>${track.name||"Unbenannte Strecke"}</b><br>Erster Läufer: ${fastArrival} Uhr<br>Letzter Läufer: ${slowArrival} Uhr<br><br>`;
  });

  if(!hasRunner) info+="Keine Strecke führt hier vorbei.";

  if(!marker._popup) marker._popup=L.popup({maxWidth:250});
  marker._popup.setLatLng(marker.getLatLng()).setContent(info).openOn(map);
}

pois.forEach(poi=>{
  const marker=L.marker(poi.coords,{icon:poiIcon}).addTo(map);
  marker.bindTooltip(poi.name);
  marker.on("click",()=>showDistancesToPoi(poi,marker));
});

// --- Slider & Update ---
function updateSliderRange(){
  const validTracks=tracks.filter(t=>t.startTime && t.endTime);
  if(validTracks.length===0){ document.getElementById("sliderContainer").style.display="none"; return; }
  const startTimes=validTracks.map(t=>timeToMinutes(t.startTime));
  const endTimes=validTracks.map(t=>timeToMinutes(t.endTime));
  slider.min=Math.min(...startTimes);
  slider.max=Math.max(...endTimes);
  slider.value=slider.min;
  timeLabel.innerText=minutesToTime(slider.value);
  document.getElementById("sliderContainer").style.display="flex";
  updateMarkers();
}
let animationFrame=null;
slider.addEventListener("input",()=>{ if(animationFrame) cancelAnimationFrame(animationFrame); animationFrame=requestAnimationFrame(updateMarkers); });

// --- Glättungsfunktion für den roten Abschnitt ---
function smoothPolyline(points, iterations = 2) {
  for (let k = 0; k < iterations; k++) {
    const newPoints = [];
    for (let i = 0; i < points.length - 1; i++) {
      const p0 = points[i];
      const p1 = points[i + 1];
      newPoints.push(L.latLng(
        0.75 * p0.lat + 0.25 * p1.lat,
        0.75 * p0.lng + 0.25 * p1.lng
      ));
      newPoints.push(L.latLng(
        0.25 * p0.lat + 0.75 * p1.lat,
        0.25 * p0.lng + 0.75 * p1.lng
      ));
    }
    newPoints.push(points[points.length - 1]);
    points = newPoints;
  }
  return points;
}

// --- Aktualisierung der Läufer-Positionen und roten Linie ---
function updateMarkers() {
  const currentMin = Number(slider.value);
  timeLabel.innerText = minutesToTime(currentMin);

  tracks.forEach(track => {
    if (!track.trackPoints || !track.startTime || !track.endTime || !track.fastSpeed || !track.slowSpeed) {
      ["fastMarker", "slowMarker", "redSegment"].forEach(k => {
        if (track[k]) { map.removeLayer(track[k]); track[k] = null; }
      });
      return;
    }

    const minsSinceStart = currentMin - timeToMinutes(track.startTime);
    const fastDist = Math.max(Math.min(track.fastSpeed * minsSinceStart, track.totalDist), 0);
    const slowDist = Math.max(Math.min(track.slowSpeed * minsSinceStart, track.totalDist), 0);

    const fastFrac = track.totalDist > 0 ? fastDist / track.totalDist : 0;
    const slowFrac = track.totalDist > 0 ? slowDist / track.totalDist : 0;

    const fastPos = interpolatePoint(track.trackPoints, fastFrac);
    const slowPos = interpolatePoint(track.trackPoints, slowFrac);

    if (track.fastMarker) track.fastMarker.setLatLng(fastPos);
    if (track.slowMarker) track.slowMarker.setLatLng(slowPos);

    if (track.redSegment) {
      map.removeLayer(track.redSegment);
      track.redSegment = null;
    }

    const subPoints = getSubsegment(
      track.trackPoints,
      Math.min(fastFrac, slowFrac),
      Math.max(fastFrac, slowFrac)
    );

    if (subPoints.length > 1) {
      const smoothPoints = smoothPolyline(subPoints, 2); // 🔹 2 = leicht geglättet
      track.redSegment = L.polyline(smoothPoints, {
        color: "red",
        weight: 6,
        opacity: 0.8
      }).addTo(map);
    }
  });
}

// --- Pace Mask Helper ---
function initPaceField(input){
  input.value="--:--";
  input.addEventListener("focus",()=>{ if(input.value==="--:--") input.value=""; });
  input.addEventListener("blur",()=>{ if(input.value==="") input.value="--:--"; });
  input.addEventListener("input",()=>{ let val=input.value.replace(/\D/g,'').slice(0,4); if(val.length>2) val=val.slice(0,2)+":"+val.slice(2); input.value=val; });
}

// --- Trackname Default-Text Helper ---
function initTrackName(trackNameEl){
  const DEFAULT_TRACK_NAME="Neue Strecke";
  trackNameEl.innerText=DEFAULT_TRACK_NAME;

  trackNameEl.addEventListener("focus",()=>{
    if(trackNameEl.innerText===DEFAULT_TRACK_NAME){
      trackNameEl.innerText="";
      const range=document.createRange();
      const sel=window.getSelection();
      range.setStart(trackNameEl,0);
      range.collapse(true);
      sel.removeAllRanges();
      sel.addRange(range);
    }
  });

  trackNameEl.addEventListener("blur",()=>{
    if(trackNameEl.innerText.trim()==="") trackNameEl.innerText=DEFAULT_TRACK_NAME;
  });
}

// --- Track Form / Add / Delete ---
function addTrackForm(){
  const trackList = document.getElementById("trackList");
  const trackDiv = document.createElement("div");
  trackDiv.className = "track";
  const existingTracks = trackList.querySelectorAll(".track");
  const color = predefinedColors[existingTracks.length % predefinedColors.length];

  trackDiv.innerHTML = `
    <div class="track-header">
      <span class="toggleSymbol">&#9654;</span>
      <span class="trackName" contenteditable="true"></span>
      <div class="colorIndicator" style="background:${color}"></div>
      <button class="deleteTrackBtn">X</button>
    </div>
    <div class="track-body">
      <label>Trackfarbe: <input type="color" class="trackColor" value="${color}"></label>
      <label>GPX-Datei: <input type="file" class="fileInput" accept=".gpx"></label>
      <label>Startzeit: <input type="time" class="startTime"></label>
      <label>Zielzeit: <input type="time" class="endTime"></label>
      <label>Schnellste Pace (min/km): <input type="text" class="fastPace" maxlength="5"></label>
      <label>Langsamste Pace (min/km): <input type="text" class="slowPace" maxlength="5"></label>
      <button class="loadBtn">Track laden</button>
      <button class="resetBtn">Reset</button>
    </div>
  `;

  trackList.appendChild(trackDiv);

  const header = trackDiv.querySelector(".track-header");
  const body = trackDiv.querySelector(".track-body");
  const toggle = header.querySelector(".toggleSymbol");
  const deleteBtn = header.querySelector(".deleteTrackBtn");
  const colorPicker = trackDiv.querySelector(".trackColor");
  const colorIndicator = trackDiv.querySelector(".colorIndicator");
  const trackNameEl = trackDiv.querySelector(".trackName");

  // --- Trackname Feature integrieren ---
  initTrackName(trackNameEl);

  initPaceField(trackDiv.querySelector(".fastPace"));
  initPaceField(trackDiv.querySelector(".slowPace"));

  header.addEventListener("click",()=>{ const open=body.style.display==="block"; body.style.display=open?"none":"block"; toggle.innerHTML=open?"&#9654;":"&#9660;"; });
  deleteBtn.addEventListener("click", (e) => {
    e.stopPropagation();
    if(trackDiv.trackObj){ ["fullTrackLayer","redSegment","fastMarker","slowMarker"].forEach(k=>{ if(trackDiv.trackObj[k]) map.removeLayer(trackDiv.trackObj[k]); }); tracks = tracks.filter(t=>t.id!==trackDiv.trackObj.id); }
    trackDiv.remove(); updateSliderRange();
    const allTracks = document.querySelectorAll("#trackList .track");
    allTracks.forEach((div,i)=>{ const newColor=predefinedColors[i%predefinedColors.length]; const cp=div.querySelector(".trackColor"); const ci=div.querySelector(".colorIndicator"); cp.value=newColor; ci.style.background=newColor; if(div.trackObj) { div.trackObj.color=newColor; if(div.trackObj.fullTrackLayer) div.trackObj.fullTrackLayer.setStyle({color:newColor}); } });
  });
  colorPicker.addEventListener("input",()=>{ colorIndicator.style.background=colorPicker.value; if(trackDiv.trackObj?.fullTrackLayer) trackDiv.trackObj.fullTrackLayer.setStyle({color:colorPicker.value}); });
  trackDiv.querySelector(".loadBtn").addEventListener("click",()=>loadTrack(trackDiv));
  trackDiv.querySelector(".resetBtn").addEventListener("click",()=>{ trackDiv.querySelector(".startTime").value=""; trackDiv.querySelector(".endTime").value=""; trackDiv.querySelector(".fastPace").value="--:--"; trackDiv.querySelector(".slowPace").value="--:--"; if(trackDiv.trackObj){ trackDiv.trackObj.startTime=null; trackDiv.trackObj.endTime=null; trackDiv.trackObj.fastSpeed=null; trackDiv.trackObj.slowSpeed=null; ["fullTrackLayer","redSegment","fastMarker","slowMarker"].forEach(k=>{ if(trackDiv.trackObj[k]) { map.removeLayer(trackDiv.trackObj[k]); trackDiv.trackObj[k]=null; } }); } updateSliderRange(); });
}

function loadTrack(trackDiv){
  const file = trackDiv.querySelector(".fileInput").files[0];
  if(!file) return alert("Bitte GPX-Datei auswählen.");

  const MAX_SIZE = 2 * 1024 * 1024;
  if(file.size > MAX_SIZE){ alert("Die Datei ist zu groß. Bitte wähle eine GPX-Datei bis maximal 2 MB."); return; }

  const color = trackDiv.querySelector(".trackColor").value;
  const reader = new FileReader();

  reader.onload = e => {
    const gpxText = e.target.result;
    const parser = new DOMParser();
    const xmlDoc = parser.parseFromString(gpxText, "text/xml");

    let nodes = xmlDoc.getElementsByTagName("trkpt");
    if(!nodes || nodes.length === 0) nodes = xmlDoc.getElementsByTagName("rtept");
    if(!nodes || nodes.length === 0){ alert("Keine Trackpunkte gefunden (trkpt/rtept)."); return; }

    const latlngs = Array.from(nodes).map(n => L.latLng(parseFloat(n.getAttribute("lat")), parseFloat(n.getAttribute("lon"))));
    if(latlngs.length === 0){ alert("Keine gültigen Koordinaten in der GPX-Datei."); return; }

    const fastPaceVal = trackDiv.querySelector(".fastPace").value;
    const slowPaceVal = trackDiv.querySelector(".slowPace").value;

    const trackObj = {
      id: Date.now() + Math.random(),
      trackPoints: latlngs,
      totalDist: totalLength(latlngs),
      color: color,
      startTime: trackDiv.querySelector(".startTime").value || null,
      endTime: trackDiv.querySelector(".endTime").value || null,
      fastSpeed: fastPaceVal && fastPaceVal!=="--:--"? paceToMetersPerMinute(fastPaceVal) : null,
      slowSpeed: slowPaceVal && slowPaceVal!=="--:--"? paceToMetersPerMinute(slowPaceVal) : null
    };

    // --- Volle Strecke auf Karte ---
    trackObj.fullTrackLayer = L.polyline(latlngs,{color,weight:4}).addTo(map);

    // --- Läufer-Marker hinzufügen ---
    trackObj.fastMarker = L.marker(latlngs[0], {icon: fastRunnerIcon}).addTo(map);
    trackObj.slowMarker = L.marker(latlngs[0], {icon: slowRunnerIcon}).addTo(map);

    // TrackObj an TrackDiv binden
    trackDiv.trackObj = trackObj;
    trackObj.name = trackDiv.querySelector(".trackName").innerText.trim();
    trackDiv.querySelector(".trackName").dataset.trackId = trackObj.id;

    // Track zu globalem Array hinzufügen
    tracks.push(trackObj);

    // Slider aktualisieren
    updateSliderRange();

    // Karte auf Track zentrieren
    map.fitBounds(trackObj.fullTrackLayer.getBounds());
  };

  reader.readAsText(file);
}

document.getElementById("addTrackBtn").addEventListener("click",addTrackForm);
</script>
</body>
</html>


