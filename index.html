<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Brauereienlauf - Streckensimulator</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="icon" type="image/svg+xml" href="icons/brauereienlauf_gestaltungselemente_maennchen_beigea_rgb.svg">
<link rel="apple-touch-icon" sizes="180x180" href="icons/brauereienlauf_gestaltungselemente_maennchen_beigea_rgb.svg">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
<style>
/* --- Global --- */
/* Grundlayout und Schriftart der Seite */
body { 
  margin: 0; 
  font-family: 'Inter', sans-serif; 
  display: flex; 
  height: 100vh; 
  overflow: hidden; 
}

/* --- Sidebar --- */
/* Layout, Hintergrund, Scroll und Schatten */
#sidebar { 
  width: 300px; 
  background: #FCF6EE; 
  color: #333; 
  padding: 10px; 
  box-shadow: 2px 0 5px rgba(0,0,0,0.1); 
  display: flex; 
  flex-direction: column; 
  gap: 10px; 
  overflow-y: auto; 
  z-index: 1000; 
}

/* Logo Bereich oben in der Sidebar */
#sidebarLogo { 
  background: #212121; 
  text-align: center; 
  margin-bottom: 10px; 
  padding: 10px; 
}
#sidebarLogo img { 
  max-width: 80%; 
  height: auto; 
  display: block; 
  margin: 0 auto; 
}

/* Farbquadrat und Delete-Button im Track Header */
.colorIndicator,
.track-header .deleteTrackBtn {
  width: 24px;
  height: 24px;
  border-radius: 4px;
  border: 1px solid #999;      
  display: flex;
  align-items: center;
  justify-content: center;
  margin-left: 5px;            
  box-sizing: border-box;
}

/* Delete-Button spezifisches Styling */
.track-header .deleteTrackBtn {
  background: #FF6600;
  color: #fff;
  border: 1px solid #999;
  font-weight: bold;
  font-size: 14px;
  line-height: 1;
  margin: 0;
  padding: 0;
  cursor: pointer;
}
.track-header .deleteTrackBtn:hover {
  background: #cc5200;
}

/* --- Track Header & Name --- */
/* Allgemeines Layout und Styling für Track Header */
.track-header { 
  display: flex; 
  align-items: center; 
  justify-content: center; /* Zentriert horizontal */
  gap: 8px; /* Abstand zwischen Farbe & Button */
  cursor: default; 
  padding: 6px 10px; 
  font-weight: bold; 
  background: #DED0BA; 
  border-bottom: 1px solid #ccc; 
  user-select: none; 
  border-radius: 6px; 
  color: #000; 
}

/* Hover-Effekte für Track Header */
.track-header .toggleSymbol { color: #000; }
.track-header:hover { background: #7664AA; }
.track-header:hover .toggleSymbol { color: #fff; }
.track-header:hover .trackName:not(:focus) { color: #fff; }

/* Track Name Eingabefeld */
.trackName { 
  flex: 1; 
  padding: 2px 4px; 
  border-radius: 4px; 
  background: transparent; 
  color: #000; 
}
.trackName:focus { 
  background: white; 
  color: #000; 
  outline: 2px solid #FF6600; 
}

/* Standard Button Styling */
button { 
  background: #FF6600; 
  color: white; 
  border: none; 
  border-radius: 4px; 
  padding: 6px 10px; 
  cursor: pointer; 
  margin-top: 6px; 
}
button:hover { background: #cc5200; }

/* --- Track Body / Form Labels & Inputs --- */
.track-body { 
  display: none; 
  padding: 8px 10px; 
}
.track-body label { 
  display: block; 
  font-size: 13px; 
  margin-top: 4px; 
}

/* Inputfelder Styling */
input[type="file"],
input[type="time"],
input[type="text"],
input[type="color"] {
  width: 100%;
  font-size: 14px;
  box-sizing: border-box;
}

/* --- Map / Slider --- */
#map { 
  flex: 1; 
  position: relative; 
  z-index: 0; 
}

/* --- Slider Styling --- */
#sliderContainer {
  position: absolute;
  bottom: 0;
  left: 321px;
  right: 0;
  background: #FCF6EE;
  padding: 10px;
  box-shadow: 0 -2px 5px rgba(0,0,0,0.1);
  display: flex;
  align-items: center;
  gap: 10px;
  z-index: 2000;
}

#timeSlider {
  -webkit-appearance: none;
  appearance: none;
  width: 100%;
  height: 6px;
  border-radius: 5px;
  outline: none;
  cursor: pointer;
  --slider-progress: 0%;
}

/* Chrome, Edge, Safari */
#timeSlider::-webkit-slider-runnable-track {
  height: 6px;
  border-radius: 5px;
  background: linear-gradient(to right, #7664AA var(--slider-progress), #DED0BA var(--slider-progress));
}
#timeSlider::-webkit-slider-thumb {
  -webkit-appearance: none;
  appearance: none;
  width: 18px;
  height: 18px;
  border-radius: 50%;
  background: #7664AA;
  border: 2px solid #FCF6EE;
  cursor: pointer;
  margin-top: -6px;
  transition: background 0.2s;
}
#timeSlider::-webkit-slider-thumb:hover { background: #5d4d8a; }

/* Firefox */
#timeSlider::-moz-range-track {
  background: #DED0BA;
  height: 6px;
  border-radius: 5px;
}
#timeSlider::-moz-range-progress {
  background: #7664AA;
  height: 6px;
  border-radius: 5px;
}
#timeSlider::-moz-range-thumb {
  width: 18px;
  height: 18px;
  border-radius: 50%;
  background: #7664AA;
  border: 2px solid #FCF6EE;
  cursor: pointer;
  transition: background 0.2s;
}
#timeSlider::-moz-range-thumb:hover { background: #5d4d8a; }

/* Zeit Label Styling */
#timeLabel { min-width: 80px; font-weight: bold; }

/* --- Leaflet Popups / Tooltips --- */
.leaflet-popup-content, 
.leaflet-tooltip { font-family: 'Inter', sans-serif; }

/* --- Optional: Alle Texte im Akkordeon und Sidebar Input/Labels --- */
.track-body * { font-family: 'Inter', sans-serif; }

/* Monospaced Zahlen in Inputs für bessere Lesbarkeit */
input[type="time"],
input[type="text"] { font-variant-numeric: tabular-nums; }
</style>
</head>
<body>

<div id="sidebar">
  <div id="sidebarLogo"><img src="icons/brauereienlauf-sued-logo.svg" alt="Brauereienlauf Logo"></div>
  <button id="addTrackBtn">Strecke hinzufügen</button>
  <div id="trackList"></div>
</div>

<div id="map"></div>

<div id="sliderContainer" style="display:none;">
  <input type="range" id="timeSlider" step="1" value="0" style="flex:1;">
  <span id="timeLabel">0:00</span>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
// --- Karte initialisieren ---
const map = L.map('map').setView([49.9, 11.0], 12);
L.tileLayer('https://tile.openstreetmap.de/{z}/{x}/{y}.png', {
  maxZoom: 19,
  attribution: '© OpenStreetMap-Mitwirkende'
}).addTo(map);

// --- Slider-Farbverlauf ---
const timeSlider = document.getElementById('timeSlider');
if (timeSlider) {
  const updateSliderColor = () => {
    const value = (timeSlider.value - timeSlider.min) / (timeSlider.max - timeSlider.min) * 100;
    timeSlider.style.setProperty('--slider-progress', `${value}%`);
  };
  timeSlider.addEventListener('input', updateSliderColor);
  updateSliderColor();
}

// --- POIs definieren ---
const pois = [
  { name: "Start und Ziel", coords: [49.91086414586559,11.008078342287886], description: "Start und Zielbereich Tanzwiesen Litzendorf" },
  { name: "Brauerei Knoblach", coords: [49.92612562825621,11.006192497921718], description: "VP Brauerei Knoblach" },
  { name: "Brauerei Hölzlein", coords: [49.916433164362154,11.044922412182059], description: "VP Brauerei Hölzlein" },
  { name: "Brauerei Hönig", coords: [49.91854570624229,11.074094351945764], description: "VP Brauerei Hönig" },
  { name: "Brauerei Reh", coords: [49.9161925538902,11.050437379307478], description: "VP Brauerei Reh" },
  { name: "Brauerei Brandholz", coords: [49.89962613596553,11.031593469565935], description: "VP Brauerei Brandholz" },
  { name: "Landgasthof Büttel", coords: [49.88168405246902,11.01294568627889], description: "VP Landgasthof Büttel" },
  { name: "Gasthof Schiller", coords: [49.85771626727418,11.005281650520448], description: "VP Gasthof Schiller" },
  { name: "Schwanenkeller", coords: [49.851879458949746,10.97576017952508], description: "VP Schwanenkeller" },
  { name: "Brauerei Sauer", coords: [49.867831104839176,10.996951685705579], description: "VP Brauerei Sauer" },
  { name: "Regnitztaler Alm", coords: [49.88765943343463,10.981377141550507], description: "VP Regnitztaler Alm" },
  { name: "Kunigundenruh", coords: [49.903828616877256,10.960579372597097], description: "VP Kunigundenruh" }
];

// --- Icons ---
const poiIcon = L.icon({
  iconUrl: "icons/brauereienlauf_gestaltungselemente_maennchen_orange_rgb.svg",
  iconSize: [32, 32],
  iconAnchor: [16, 32],
  popupAnchor: [0, -32]
});

const fastRunnerIcon = L.icon({
  iconUrl: 'icons/brauereienlauf_gestaltungselemente_maennchen_gruen_rgb.svg',
  iconSize: [24, 24],
  iconAnchor: [12, 12]
});

const slowRunnerIcon = L.icon({
  iconUrl: 'icons/brauereienlauf_gestaltungselemente_maennchen_orange_rgb.svg',
  iconSize: [24, 24],
  iconAnchor: [12, 12]
});

// --- Globale Variablen ---
let tracks = [];
const predefinedColors = ["#36542C","#FF6600","#7664AA","#212121","#DED0BA"];

// --- Vordefinierte Strecken ---
const predefinedTracks = [
  { name:"Marathon", gpx:"tracks/M.gpx", startTime:"09:00", endTime:"16:00", fastPace:"03:30", slowPace:"09:00" },
  { name:"Halbmarathon", gpx:"tracks/HM.gpx", startTime:"11:00", endTime:"16:00", fastPace:"03:30", slowPace:"09:00" },
  { name:"10 km", gpx:"tracks/10k.gpx", startTime:"13:00", endTime:"16:00", fastPace:"03:30", slowPace:"09:00" },
  { name:"5 km", gpx:"tracks/5k.gpx", startTime:"13:30", endTime:"16:00", fastPace:"03:30", slowPace:"09:00" }
];

// --- Hilfsfunktionen ---
function parsePace(p) { if (!p || p === "--:--") return null; const [m,s] = p.split(":").map(Number); return m*60+(s||0); }
function paceToMetersPerMinute(p) { const s = parsePace(p); return s ? 1000 / (s / 60) : null; }
function totalLength(latlngs){ let d=0; for(let i=1;i<latlngs.length;i++) d+=latlngs[i-1].distanceTo(latlngs[i]); return d; }
function timeToMinutes(t){ const [h,m] = t.split(":").map(Number); return h*60+m; }
function minutesToTime(m){ const h=Math.floor(m/60), mm=m%60; return `${h.toString().padStart(2,'0')}:${mm.toString().padStart(2,'0')}`; }

// --- POIs auf Karte ---
pois.forEach(poi=>{
  const m=L.marker(poi.coords,{icon:poiIcon}).addTo(map);
  m.bindTooltip(poi.name);
  m.on("click",()=>showDistancesToPoi(poi,m));
});

function showDistancesToPoi(poi, marker){
  const poiLatLng=L.latLng(poi.coords);
  let info=`<b>${poi.name}</b><br>${poi.description}<hr>`;
  let hasRunner=false;
  tracks.forEach(track=>{
    if(!track.trackPoints)return;
    const total=track.totalDist;
    let minDist=Infinity, distAlong=0, soFar=0;
    for(let i=1;i<track.trackPoints.length;i++){
      const a=track.trackPoints[i-1],b=track.trackPoints[i];
      const seg=a.distanceTo(b);
      const min=Math.min(a.distanceTo(poiLatLng),b.distanceTo(poiLatLng));
      if(min<minDist){minDist=min;distAlong=soFar;}
      soFar+=seg;
    }
    if(minDist>50) return;
    hasRunner=true;
    const tStart=timeToMinutes(track.startTime);
    const fast=timeToMinutes(track.startTime)+distAlong/track.fastSpeed;
    const slow=timeToMinutes(track.startTime)+distAlong/track.slowSpeed;
    info+=`<b>${track.name}</b><br>Erster Läufer: ${minutesToTime(fast)} Uhr<br>Letzter Läufer: ${minutesToTime(slow)} Uhr<br><br>`;
  });
  if(!hasRunner) info+="Keine Strecke führt hier vorbei.";
  marker.bindPopup(info).openPopup();
}

// --- Slider + Marker Update ---
const slider=document.getElementById("timeSlider");
const timeLabel=document.getElementById("timeLabel");

function updateMarkers(){
  const cur=Number(slider.value);
  timeLabel.innerText=minutesToTime(cur);
  tracks.forEach(t=>{
    if(!t.trackPoints)return;
    const mins=cur-timeToMinutes(t.startTime);
    const fDist=Math.min(t.fastSpeed*mins,t.totalDist);
    const sDist=Math.min(t.slowSpeed*mins,t.totalDist);
    const fFrac=fDist/t.totalDist, sFrac=sDist/t.totalDist;
    const fPos=t.trackPoints[Math.floor(fFrac*(t.trackPoints.length-1))];
    const sPos=t.trackPoints[Math.floor(sFrac*(t.trackPoints.length-1))];
    if(t.fastMarker)t.fastMarker.setLatLng(fPos);
    if(t.slowMarker)t.slowMarker.setLatLng(sPos);
  });
}
slider.addEventListener("input",()=>requestAnimationFrame(updateMarkers));

// --- Reset ---
function resetTrackSettings(div, start, end, fast, slow){
  div.querySelector(".startTime").value=start;
  div.querySelector(".endTime").value=end;
  div.querySelector(".fastPace").value=fast;
  div.querySelector(".slowPace").value=slow;
  if(div.trackObj){
    const {fastMarker,slowMarker,trackPoints}=div.trackObj;
    if(trackPoints?.length){
      fastMarker.setLatLng(trackPoints[0]);
      slowMarker.setLatLng(trackPoints[0]);
    }
  }
}

// --- GPX laden ---
function loadGpxFile(file,div){
  const r=new FileReader();
  r.onload=e=>parseGpxAndAddTrack(e.target.result,div);
  r.readAsText(file);
}
function loadPredefinedGpx(path,div){
  fetch(path).then(r=>r.text()).then(txt=>parseGpxAndAddTrack(txt,div));
}
function parseGpxAndAddTrack(txt,div){
  const xml=new DOMParser().parseFromString(txt,"text/xml");
  const pts=[...xml.getElementsByTagName("trkpt")].map(n=>L.latLng(+n.getAttribute("lat"),+n.getAttribute("lon")));
  const color=div.querySelector(".trackColor").value;
  const start=div.querySelector(".startTime").value;
  const end=div.querySelector(".endTime").value;
  const fast=div.querySelector(".fastPace").value;
  const slow=div.querySelector(".slowPace").value;
  const obj={
    trackPoints:pts,
    totalDist:totalLength(pts),
    fastSpeed:paceToMetersPerMinute(fast),
    slowSpeed:paceToMetersPerMinute(slow),
    startTime:start,
    endTime:end,
    name:div.querySelector(".trackName").innerText,
    fullTrackLayer:L.polyline(pts,{color,weight:5}).addTo(map),
    fastMarker:L.marker(pts[0],{icon:fastRunnerIcon}).addTo(map),
    slowMarker:L.marker(pts[0],{icon:slowRunnerIcon}).addTo(map)
  };
  div.trackObj=obj;
  tracks.push(obj);
  map.fitBounds(obj.fullTrackLayer.getBounds());
}

// --- Track hinzufügen (Akkordeon) ---
function addTrackForm(predef){
  const list=document.getElementById("trackList");
  const div=document.createElement("div");
  div.className="track";
  const color=predefinedColors[list.querySelectorAll(".track").length%predefinedColors.length];
  div.innerHTML=`
    <div class="track-header">
      <span class="toggleSymbol">&#9654;</span>
      <span class="trackName" contenteditable="true">${predef?.name||"Neue Strecke"}</span>
      <div class="colorIndicator" style="background:${color}"></div>
      <button class="deleteTrackBtn">X</button>
    </div>
    <div class="track-body">
      <label>GPX-Datei: <input type="file" class="gpxFileInput" accept=".gpx"></label>
      <button class="loadGpxBtn" style="background:#FF6600;color:white;border:none;border-radius:4px;margin-top:6px;">Track laden</button>
      <label>Startzeit: <input type="time" class="startTime" value="${predef?.startTime||''}"></label>
      <label>Zielzeit: <input type="time" class="endTime" value="${predef?.endTime||''}"></label>
      <label>Schnellste Pace (min/km): <input type="text" class="fastPace" value="${predef?.fastPace||'--:--'}"></label>
      <label>Langsamste Pace (min/km): <input type="text" class="slowPace" value="${predef?.slowPace||'--:--'}"></label>
      <label>Trackfarbe: <input type="color" class="trackColor" value="${color}"></label>
      <button class="resetBtn" style="background:#FF6600;color:white;border:none;border-radius:4px;margin-top:6px;">⟳ Zurücksetzen</button>
    </div>`;
  list.appendChild(div);

  const head=div.querySelector(".track-header");
  const body=div.querySelector(".track-body");
  const toggle=head.querySelector(".toggleSymbol");
  const isPredef=!!predef;
  if(!isPredef){ body.style.display="block"; toggle.innerHTML="&#9660;"; }
  else { body.style.display="none"; toggle.innerHTML="&#9654;"; }

  head.addEventListener("click",()=>{
    const open=body.style.display==="block";
    body.style.display=open?"none":"block";
    toggle.innerHTML=open?"&#9654;":"&#9660;";
  });

  div.querySelector(".deleteTrackBtn").addEventListener("click",()=>{
    if(div.trackObj) map.removeLayer(div.trackObj.fullTrackLayer);
    div.remove();
  });

  div.querySelector(".resetBtn").addEventListener("click",()=>resetTrackSettings(div,predef?.startTime||"",predef?.endTime||"",predef?.fastPace||"--:--",predef?.slowPace||"--:--"));
  div.querySelector(".loadGpxBtn").addEventListener("click",()=>{
    const fileInput=div.querySelector(".gpxFileInput");
    if(fileInput.files.length) loadGpxFile(fileInput.files[0],div);
    else if(predef?.gpx) loadPredefinedGpx(predef.gpx,div);
    else alert("Bitte eine GPX-Datei auswählen!");
  });
}

// --- Initialisierung ---
predefinedTracks.forEach(t=>addTrackForm(t));
</script>
</body>
</html>
